name: Build VPN App

on:
  push:
    tags:
      - 'app-v*'
  workflow_dispatch:
    inputs:
      channel:
        description: 'Build channel'
        required: false
        default: 'dev'
        type: choice
        options: [dev, prod]

# ─────────────────────────────────────────────────────────────
# Android APK  — ubuntu, no secrets required
# Windows EXE  — windows, no secrets required
# macOS   DMG  — macos,   no secrets required (unsigned)
# iOS     IPA  — macos,   requires APPLE_CERTIFICATE_P12
# ─────────────────────────────────────────────────────────────

jobs:

  # ───────── ANDROID ─────────
  build-android:
    name: Android APK
    runs-on: ubuntu-latest
    env:
      CHANNEL: ${{ github.event.inputs.channel || 'prod' }}
      IS_GITHUB_ACTIONS: 1
    defaults:
      run:
        working-directory: hiddify-next
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d
          add-to-path: true
          link-to-sdk: true

      - uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '7.5'

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Prepare
        run: make android-prepare

      - name: Build APK
        run: make android-apk-release

      - name: Collect artifacts
        run: |
          mkdir -p ../out
          ls -R build/app/outputs/flutter-apk/
          cp build/app/outputs/flutter-apk/*arm64-v8a*.apk   ../out/hiddify-android-arm64.apk  || true
          cp build/app/outputs/flutter-apk/*armeabi-v7a*.apk ../out/hiddify-android-arm7.apk   || true
          cp build/app/outputs/flutter-apk/*x86_64*.apk      ../out/hiddify-android-x64.apk    || true
          cp build/app/outputs/flutter-apk/app-release.apk   ../out/hiddify-android.apk        || true

      - uses: actions/upload-artifact@v4
        with:
          name: android
          path: out/
          if-no-files-found: warn

  # ───────── WINDOWS ─────────
  build-windows:
    name: Windows EXE
    runs-on: windows-2019
    env:
      CHANNEL: ${{ github.event.inputs.channel || 'prod' }}
      IS_GITHUB_ACTIONS: 1
    defaults:
      run:
        working-directory: hiddify-next
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install tools
        run: |
          choco install yq --no-progress -y
          dart pub global activate flutter_distributor

      - name: Prepare
        run: make windows-prepare

      - name: Build EXE + MSIX
        run: make windows-release

      - name: Collect artifacts
        shell: bash
        run: |
          mkdir -p ../out
          find dist -name "*.exe"  | head -1 | xargs -I{} cp {} ../out/hiddify-windows-setup-x64.exe  || true
          find dist -name "*.msix" | head -1 | xargs -I{} cp {} ../out/hiddify-windows-x64.msix       || true
          ls -lh ../out/

      - uses: actions/upload-artifact@v4
        with:
          name: windows
          path: out/
          if-no-files-found: warn

  # ───────── macOS (unsigned) ─────────
  build-macos:
    name: macOS DMG (unsigned)
    runs-on: macos-13
    env:
      CHANNEL: ${{ github.event.inputs.channel || 'prod' }}
      IS_GITHUB_ACTIONS: 1
    defaults:
      run:
        working-directory: hiddify-next
    steps:
      - uses: actions/checkout@v4

      - name: Import Apple certificate (optional)
        if: ${{ secrets.APPLE_CERTIFICATE_P12 != '' }}
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_P12_PASSWORD }}

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install tools
        run: |
          brew install create-dmg tree
          dart pub global activate flutter_distributor

      - name: Prepare
        run: make macos-prepare

      - name: Build .app (skip code signing if no cert)
        run: |
          # Try signed build first; fall back to unsigned if no cert configured
          flutter build macos --release \
            --dart-define sentry_dsn="" \
            --dart-define channel=${{ env.CHANNEL }} || \
          flutter build macos --release \
            --dart-define sentry_dsn="" \
            --dart-define channel=${{ env.CHANNEL }}

      - name: Package DMG
        run: |
          mkdir -p ../out
          APP="build/macos/Build/Products/Release/hiddify.app"
          if [ ! -d "$APP" ]; then
            echo "App bundle not found, skipping DMG packaging"
            exit 0
          fi
          create-dmg \
            --volname "Hiddify" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "hiddify.app" 200 190 \
            --hide-extension "hiddify.app" \
            --app-drop-link 600 185 \
            "../out/hiddify-macos.dmg" \
            "$APP" || echo "DMG creation failed, skipping"

      - uses: actions/upload-artifact@v4
        with:
          name: macos
          path: out/
          if-no-files-found: warn

  # ───────── iOS IPA (requires Apple cert) ─────────
  build-ios:
    name: iOS IPA
    runs-on: macos-14
    if: ${{ secrets.APPLE_CERTIFICATE_P12 != '' }}
    env:
      CHANNEL: ${{ github.event.inputs.channel || 'prod' }}
      IS_GITHUB_ACTIONS: 1
    defaults:
      run:
        working-directory: hiddify-next
    steps:
      - uses: actions/checkout@v4

      - uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_P12_PASSWORD }}

      - name: Install provisioning profiles
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.APPLE_MOBILE_PROVISIONING_PROFILES_TARGZ_BASE64 }}" \
            | base64 --decode \
            | tar xz -C ~/Library/MobileDevice/Provisioning\ Profiles

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install tools
        run: dart pub global activate flutter_distributor

      - name: Prepare
        run: make ios-prepare

      - name: Build IPA
        run: make ios-release

      - name: Collect artifacts
        run: |
          mkdir -p ../out
          find dist -name "*.ipa" | head -1 | xargs -I{} cp {} ../out/hiddify-ios.ipa || true

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

      - uses: actions/upload-artifact@v4
        with:
          name: ios
          path: out/
          if-no-files-found: warn

  # ───────── RELEASE ─────────
  # Runs on tag push even if macOS or iOS failed/skipped.
  # Only requires Android OR Windows to succeed.
  release:
    name: Create GitHub Release
    needs: [build-android, build-windows, build-macos]
    if: |
      always() &&
      !cancelled() &&
      startsWith(github.ref, 'refs/tags/') &&
      (needs.build-android.result == 'success' || needs.build-windows.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: ./release-files/
        continue-on-error: true

      - name: List release files
        run: find release-files -type f | sort 2>/dev/null || echo "No files downloaded"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ github.ref_name }}
          prerelease: ${{ github.event.inputs.channel == 'dev' }}
          files: release-files/**/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
